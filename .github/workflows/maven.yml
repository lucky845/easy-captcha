name: Java CI with Maven

on:
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      # ğŸ”§ ç²¾å‡†ç¼“å­˜ç­–ç•¥
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ğŸ› è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4.6.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven  # ç¼“å­˜ JDK ç¯å¢ƒé…ç½®

      # âš™ï¸ æ„å»ºä¸æµ‹è¯•
      - name: Build project
        run: mvn clean verify -B --file pom.xml

      # ğŸ§© å¹¶è¡Œæµ‹è¯•é…ç½®ï¼ˆæ ¹æ®é¡¹ç›®ç»“æ„è°ƒæ•´ï¼‰
      #      - name: Configure parallel tests
      #        run: |
      #          cat <<EOF >> .mvn/maven-opts.txt
      #          -Dtest.groups=fast
      #          -Dparallel=methods,threads=5
      #          EOF

      #      - name: Run tests
      #        run: mvn test -B --file pom.xml

      # ğŸ“Š ç”Ÿæˆä¾èµ–æ ‘ï¼ˆç›´æ¥è¾“å‡ºåˆ°æ—¥å¿—ï¼‰
      - name: Show dependency tree
        run: mvn dependency:tree -DoutputFile=dependency-tree.txt | tee dependency-tree.txt

      # ğŸ› ï¸ ä¸Šä¼ ä¾èµ–æ ‘ï¼ˆå¯é€‰ï¼‰
      - name: Upload dependency tree
        if: always()  # åªåœ¨éœ€è¦æ—¶å–æ¶ˆæ³¨é‡Š
        uses: actions/upload-artifact@v4.6.0
        with:
          name: dependency-tree
          path: dependency-tree.txt

      # ğŸ” ä»£ç è´¨é‡æ‰«æï¼ˆå¯é€‰æ‰©å±•ï¼‰
      #      - name: Scan with SonarQube
      #        uses: SonarSource/sonarqube-github-action@master
      #        with:
      #          args: >
      #            -Dsonar.projectKey=my-project-key
      #            -Dsonar.organization=github-organization
      #            -Dsonar.sources=src/main/java

      # âš ï¸ å¼ºåˆ¶å¤±è´¥æ£€æŸ¥
      - name: Check build status
        run: |
          if [ $? -ne 0 ]; then
            echo "::error::Build failed. Check logs for details"
            exit 1
          fi

  # ğŸš€ å¿«é€Ÿåˆå¹¶ï¼ˆå¯é€‰é›†æˆï¼‰
#  auto-merge:
#    needs: build-and-test
#    runs-on: ubuntu-latest
#    if: github.actor == 'dependabot[bot]' && github.event.pull_request.mergeable
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Merge PR
#        run: |
#          git pull origin main --rebase
#          git push origin HEAD:main --force-with-lease
#      - name: Close PR
#        uses: peter-evans/close-pull-request@v1
#        with:
#          pull_number: ${{ github.event.pull_request.number }}
