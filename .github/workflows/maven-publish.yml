name: Maven Package & Release

on:
  pull_request:
    branches: [ "master" ]
    types: [ closed ]
  release:
    types: [ created ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # ğŸ”§ ç²¾å‡†ç¼“å­˜ç­–ç•¥ï¼ˆå¤šæ¨¡å—é¡¹ç›®é€‚ç”¨ï¼‰
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-maven-
            ${{ runner.os }}-maven-*

      # ğŸ› è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # âš™ï¸ æ„å»ºä¸åŸºç¡€æµ‹è¯•
      - name: Build project
        run: mvn clean verify -B --file pom.xml

      # ğŸ“Š ç”Ÿæˆä¾èµ–æ ‘ï¼ˆå¯é€‰ï¼‰
      - name: Show dependency tree
        run: mvn dependency:tree -DoutputFile=dependency-tree.txt | tee dependency-tree.txt

  publish-package:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      packages: write

    if: |
      github.event_name == 'release'

    steps:
      - uses: actions/checkout@v4

      # ğŸ”§ å¤ç”¨æ„å»ºç¼“å­˜
      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-maven-
            ${{ runner.os }}-maven-*

      # ğŸ› ï¸ æ‰§è¡Œå‘å¸ƒ
      - name: Build and publish
        run: mvn --batch-mode deploy -s $GITHUB_WORKSPACE/settings.xml -P github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAVEN_OPTS: "-Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}"

      # âœ… ç‰ˆæœ¬éªŒè¯
      - name: Verify published artifact
        run: |
          curl -s https://api.github.com/packages/github.com/${{ github.repository }}/maven/v1/packages/${{ github.event.release.tag_name }}/version \
          | jq '.version' | grep -q "^${{ github.event.release.tag_name }}\$"

      # ğŸ“¢ å‘å¸ƒé€šçŸ¥
      - name: Send release notification
        uses: github/actions/send-notification@v3
        with:
          subject: "ğŸš€ Release ${github.event.release.tag_name} å·²å‘å¸ƒ"
          body: |
            ## ğŸ‰ å‘å¸ƒæˆåŠŸé€šçŸ¥
            
            - **ç‰ˆæœ¬**: ${github.event.release.tag_name}
            - **ä»“åº“**: [${github.repository}](${github.repository_url})
            - **æ„å»ºæ—¥å¿—**: [ç‚¹å‡»æŸ¥çœ‹](${github.server_url}/${github.repository}/actions/runs/${github.run_id})
